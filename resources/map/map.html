<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GCS Map</title>

  <!-- OpenLayers CSS -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css" />
  <style>
    html, body { margin: 0; height: 100% }
    #map       { width: 100%; height: 100% }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- OpenLayers kütüphanesi -->
  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>

  <!-- 1) Dinamik zoom kontrolörü global olarak yükleniyor -->
  <script src="./dynamicZoomController.js"></script>

  <!-- 2) Harita, drone, pathLine ve controller kodu -->
  <script>
    const HOME_LAT  = 37.06257608177816,
          HOME_LON  = 35.35287244257858,
          ZOOM_INIT = 18;

    // Harita ve view oluşturma
    const map = new ol.Map({
      target: 'map',
      layers: [
        new ol.layer.Tile({ source: new ol.source.OSM() })
      ],
      view: new ol.View({
        center: ol.proj.fromLonLat([HOME_LON, HOME_LAT]),
        zoom:   ZOOM_INIT
      })
    });
    const view = map.getView();

    // Drone ikonu
    const droneStyle = new ol.style.Style({
      image: new ol.style.Icon({
        src: 'drone.png',
        anchor: [0.5, 0.5],
        rotateWithView: true,
        scale: 0.08
      })
    });
    const droneFeature = new ol.Feature(
      new ol.geom.Point(ol.proj.fromLonLat([HOME_LON, HOME_LAT]))
    );
    droneFeature.setStyle(droneStyle);

    // Polyline
    const pathLine = new ol.geom.LineString([]);
    const pathFeature = new ol.Feature(pathLine);
    pathFeature.setStyle(new ol.style.Style({
      stroke: new ol.style.Stroke({ color: '#FF6200', width: 2 })
    }));

    // Vector katmanına ekle
    const vectorLayer = new ol.layer.Vector({
      source: new ol.source.Vector({ features: [pathFeature, droneFeature] })
    });
    map.addLayer(vectorLayer);

    // 3) DynamicZoomController örneğini oluştur
    const dz = new DynamicZoomController(
      map,
      pathLine,
      view,
      {
        padding: [50,50,50,50],
        maxZoom: 18,
        duration: 300,
        fastDuration: 0,
        throttleInterval: 300
      }
    );

    // 4) Python'dan gelen çağrılar controller'a yönlensin
    window.disableAutoFollow         = () => dz.disable();
    window.enableAutoFollowAndFocus = () => dz.enable();
    window.updatePose = (lat, lon, yawDeg) => {
      const coord = ol.proj.fromLonLat([lon, lat]);

      // a) Drone pozisyonu ve yön güncelle
      droneFeature.getGeometry().setCoordinates(coord);
      droneStyle.getImage().setRotation(-yawDeg * Math.PI / 180);
      droneFeature.changed();

      // b) Polyline'a ekle, ring-buffer koru
      pathLine.appendCoordinate(coord);
      if (pathLine.getCoordinates().length > 2000) {
        pathLine.setCoordinates(
          pathLine.getCoordinates().slice(-2000)
        );
      }

      // c) Dinamik zoom kontrolörünü bilgilendir
      dz.update(coord);
    };
  </script>
</body>
</html>
