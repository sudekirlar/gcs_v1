<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GCS Map</title>

  <!-- OpenLayers CSS -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css" />
  <style>
    html, body { margin: 0; height: 100% }
    #map       { width: 100%; height: 100% }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
  <script>
  /* ---------- Sabitler ---------- */
  const HOME_LAT  = 37.06257608177816,
        HOME_LON  = 35.35287244257858,
        ZOOM_INIT = 18;

  /* ---------- Harita ---------- */
  const map = new ol.Map({
    target : 'map',
    layers : [ new ol.layer.Tile({ source: new ol.source.OSM() }) ],
    view   : new ol.View({
      center: ol.proj.fromLonLat([HOME_LON, HOME_LAT]),
      zoom  : ZOOM_INIT
    })
  });

  /* ---------- Drone ikonu ---------- */
  const droneStyle = new ol.style.Style({
    image: new ol.style.Icon({
      src           : 'drone.png',      // aynı klasörde .png ya da .svg
      anchor        : [0.5, 0.5],
      rotateWithView: true,
      scale         : 0.08
    })
  });

  const droneFeature = new ol.Feature(
    new ol.geom.Point( ol.proj.fromLonLat([HOME_LON, HOME_LAT]) )
  );
  droneFeature.setStyle(droneStyle);

  /* ---------- Polyline ---------- */
  const pathLine    = new ol.geom.LineString([]);
  const pathFeature = new ol.Feature(pathLine);
  pathFeature.setStyle(
    new ol.style.Style({
      stroke: new ol.style.Stroke({ color: '#FF6200', width: 2 })
    })
  );

  /* ---------- Katman ---------- */
  const vectorLayer = new ol.layer.Vector({
    source: new ol.source.Vector({ features: [pathFeature, droneFeature] })
  });
  map.addLayer(vectorLayer);

  /* ---------- AUTO-FOLLOW bayrağı ---------- */
  let autoFollow = true;

  /* Kullanıcı haritayı elle oynatırsa auto-follow'u kapat */
  map.on('movestart', evt => {
    if (evt.originalEvent) autoFollow = false;
  });
  // Ek etkileşimler: fare/drag/zoom ile de devre dışı bırak
  map.on('pointerdrag',       () => { autoFollow = false; });
  map.getView().on('change:resolution', () => { autoFollow = false; });
  map.getViewport().addEventListener('pointerdown', () => { autoFollow = false; });

  /* Polyline'i ekrana sığdıran yardımcı */
  function fitPath() {
    map.getView().fit(pathLine, {
      padding : [50, 50, 50, 50],   // px kenar boşluk
      maxZoom : 18,                 // fazla yakınlaşma engeli
      duration: 300                 // animasyon ms
    });
  }

  /* Python → haritaya odak dönüş düğmesi */
  function enableAutoFollowAndFocus() {
    autoFollow = true;
    if (pathLine.getCoordinates().length) fitPath();
  }

  /* —— YENİ EKLENDİ: Dinamik zoom’u JS tarafında devre dışı bırakmak için —— */
  function disableAutoFollow() {
    autoFollow = false;
  }
  /* ———————————————————————————————————————————————————————————————— */

  /* ===========================================================
       TEK GİRİŞ NOKTASI ── Python:  updatePose(lat, lon, yaw)
     =========================================================== */
  function updatePose(lat, lon, yawDeg)
  {
    const coord = ol.proj.fromLonLat([lon, lat]);

    /* 1) Konum + isteğe bağlı merkezleme */
    droneFeature.getGeometry().setCoordinates(coord);
    if (autoFollow) map.getView().setCenter(coord);

    /* 2) Yön  (OpenLayers saat yönünü (+) kabul ediyor) */
    droneStyle.getImage().setRotation(-yawDeg * Math.PI / 180);
    droneFeature.changed();

    /* 3) Polyline  + ring-buffer */
    pathLine.appendCoordinate(coord);
    if (pathLine.getCoordinates().length > 2000)
        pathLine.setCoordinates(pathLine.getCoordinates().slice(-2000));

    /* 4) Çizgiyi ekrana sığdır */
    if (autoFollow) fitPath();
  }
  </script>
</body>
</html>
